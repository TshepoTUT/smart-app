generator client {
  provider = "prisma-client-js"
  output   = "./generate/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  ORGANIZER
  ATTENDEE
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  CHECKED_IN
  CHECKED_OUT
  ATTENDED
  NO_SHOW
}

enum ApprovalType {
  SAFETY
  LIQUOR
  NOISE
  GENERAL
  ORGANIZER_DOC
  ATTENDEE_DOC
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TokenType {
  REFRESH
  RESET_PASSWORD
  VERIFY_EMAIL
}

enum DocType {
  ID
  PROOF_OF_EMPLOYMENT
  ORGANIZER_CERT
  INVOICE
  OTHER
}

enum DocStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PurchaseStatus {
  INITIATED
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CARD
  EFT
  CASH
}

enum RateType {
  PER_HOUR
  PER_DAY
  OTHER
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  OVERDUE
}

enum VenueType {
  AUDITORIUM
  CLASSROOM
  HALL
  OTHER
}

enum RegistrationStatus {
  PENDING
  APPROVED
  REJECTED
  ALLOCATED
  CANCELLED
}

enum BookingStatus {
  PENDING_DEPOSIT
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  name             String
  role             Role
  address          String?
  cellphone_number String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  active           Boolean   @default(true)

  account                   Account?
  organizerProfile          OrganizerProfile?
  organizedEvents           Event[]            @relation("OrganizerEvents")
  registrations             Registration[]
  attendance                Attendance[]
  tickets                   Ticket[]
  documents                 Document[]
  verifiedOrganizerProfiles OrganizerProfile[] @relation("AdminVerifications")
  purchases                 Purchase[]
  approvals                 Approval[]         @relation("Approver")
  reports                   Report[]
  bookings                  Booking[]
  calendarsCreated          Calendar[]         @relation("UserCreatedCalendars")
}

model Account {
  id                  String   @id @default(uuid())
  userId              String   @unique
  passwordHash        String
  emailVerified       Boolean  @default(false)
  failedLoginAttempts Int      @default(0)
  lockedAt            DateTime?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  user     User        @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  sessions Session[]
  tokens   AuthToken[]
}

model Session {
  id        String   @id @default(uuid())
  accountId String
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  expiresAt DateTime

  account Account @relation(fields: [accountId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model AuthToken {
  id        String    @id @default(uuid())
  accountId String
  type      TokenType
  token     String    @unique @db.VarChar(512)
  createdAt DateTime  @default(now())
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  account Account @relation(fields: [accountId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model OrganizerProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  isInternal        Boolean  @default(false)
  verified          Boolean  @default(false)
  verifiedByAdminId String?
  verifiedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user            User       @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  uploadedDocs    Document[]
  approvals       Approval[] @relation("OrganizerApprovals")
  verifiedByAdmin User?      @relation("AdminVerifications", fields: [verifiedByAdminId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model Document {
  id                 String    @id @default(uuid())
  userId             String
  eventId            String?
  purchaseId         String?
  bookingId          String?
  type               DocType   @default(ID)
  filename           String
  mimetype           String?
  url                String?
  content            Bytes?
  size               Int?
  eventName          String?
  status             DocStatus @default(PENDING)
  submittedAt        DateTime  @default(now())
  reviewedAt         DateTime?
  reviewedBy         String?
  deletedAt          DateTime?
  organizerProfileId String?

  user             User              @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  event            Event?            @relation(fields: [eventId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  purchase         Purchase?         @relation(fields: [purchaseId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  booking          Booking?          @relation(fields: [bookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  organizerProfile OrganizerProfile? @relation(fields: [organizerProfileId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([purchaseId, type])
  @@index([bookingId, type])
}

model Venue {
  id       String @id @default(uuid())
  name     String @unique
  location String
  capacity Int

  type         VenueType @default(HALL)
  typeOther    String?
  rateType     RateType  @default(PER_DAY)
  price        Decimal
  depositValue Decimal?
  rating       Int?      @default(0)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  imageUrls Json
  events    Event[]
  tools     Tool[]
  bookings  Booking[]
}

model Purchase {
  id                  String         @id @default(uuid())
  userId              String
  eventId             String
  amount              Decimal
  currency            String         @default("ZAR")
  status              PurchaseStatus @default(INITIATED)
  paymentMethod       PaymentMethod?
  providerTransaction String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  deletedAt           DateTime?
  ticketDefinitionId  String

  user      User       @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  tickets   Ticket[]
  documents Document[]
  invoice   Invoice?
}

model Booking {
  id              String        @id @default(uuid())
  eventId         String        @unique
  organizerId     String
  venueId         String
  calculatedCost  Decimal
  depositRequired Decimal?
  depositPaid     Boolean       @default(false)
  totalPaid       Decimal       @default(0.0)
  status          BookingStatus @default(PENDING_PAYMENT)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  calendarId      String?

  event     Event      @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  organizer User       @relation(fields: [organizerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  venue     Venue      @relation(fields: [venueId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  invoice   Invoice?
  documents Document[]
  calendar  Calendar?  @relation("CalendarBookings", fields: [calendarId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model Invoice {
  id            String        @id @default(uuid())
  purchaseId    String?       @unique
  bookingId     String?       @unique
  invoiceNo     String        @unique
  amount        Decimal
  currency      String        @default("ZAR")
  issuedAt      DateTime      @default(now())
  status        InvoiceStatus @default(PENDING)
  venueIssuerId String

  venueIssuer VenueIssuer @relation(fields: [venueIssuerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  purchase    Purchase?   @relation(fields: [purchaseId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  booking     Booking?    @relation(fields: [bookingId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model VenueIssuer {
  id                 String  @id @default(uuid())
  institutionName    String
  institutionAddress Json
  institutionLogoUrl String?
  institutionLogo    Bytes?
  otherDetails       Json

  invoices Invoice[]
}

model Tool {
  id        String   @id @default(uuid())
  name      String   @unique
  quantity  Int      @default(1)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  venues Venue[]
}

model Event {
  id                           String      @id @default(uuid())
  name                         String
  description                  String
  startDateTime                DateTime
  endDateTime                  DateTime
  status                       EventStatus @default(DRAFT)
  expectedAttend               Int?
  totalTickets                 Int?
  isFree                       Boolean     @default(true)
  ticketRequired               Boolean     @default(true)
  autoDistribute               Boolean     @default(true)
  allowAttendeePurchase        Boolean     @default(false)
  createdAt                    DateTime    @default(now())
  updatedAt                    DateTime    @updatedAt
  deletedAt                    DateTime?
  venueId                      String
  organizerId                  String
  themeId                      String?
  requestedResourcesAndServices Json?

  venue             Venue              @relation(fields: [venueId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  organizer         User               @relation("OrganizerEvents", fields: [organizerId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  theme             Theme?             @relation(fields: [themeId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  registrations     Registration[]
  attendance        Attendance[]
  approvals         Approval[]         @relation("EventApprovals")
  reports           Report[]
  tickets           Ticket[]
  liquorRequests    LiquorRequest[]
  documents         Document[]
  purchases         Purchase[]
  ticketDefinitions TicketDefinition[]
  booking           Booking?
}

model TicketDefinition {
  id        String    @id @default(uuid())
  eventId   String
  name      String
  price     Decimal
  quantity  Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  event   Event    @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  tickets Ticket[]

  @@unique([eventId, name])
}

model Registration {
  id              String             @id @default(uuid())
  userId          String
  eventId         String
  createdAt       DateTime           @default(now())
  source          String?
  requestedTicket Boolean            @default(true)
  status          RegistrationStatus @default(PENDING)

  user   User    @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  event  Event   @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  ticket Ticket?

  @@unique([userId, eventId])
}

model Attendance {
  id        String           @id @default(uuid())
  userId    String
  eventId   String
  status    AttendanceStatus
  checkedAt DateTime         @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@unique([userId, eventId])
}

model Ticket {
  id                 String    @id @default(uuid())
  eventId            String
  userId             String?
  registrationId     String?   @unique
  purchaseId         String?
  ticketDefinitionId String
  type               String
  price              Decimal
  qrcodeORurl        Json
  issuedAt           DateTime  @default(now())
  redeemed           Boolean   @default(false)
  redeemedAt         DateTime?
  deletedAt          DateTime?

  event            Event            @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  user             User?            @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  registration     Registration?    @relation(fields: [registrationId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  purchase         Purchase?        @relation(fields: [purchaseId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  ticketDefinition TicketDefinition @relation(fields: [ticketDefinitionId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model LiquorRequest {
  id           String   @id @default(uuid())
  eventId      String
  startTime    DateTime
  endTime      DateTime
  policyAgreed Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  approvalId   String?  @unique

  event    Event     @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  approval Approval? @relation(fields: [approvalId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model Approval {
  id                 String         @id @default(uuid())
  targetType         String
  targetId           String
  type               ApprovalType
  status             ApprovalStatus @default(PENDING)
  approverId         String?
  notes              String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  organizerProfileId String?
  eventId            String?

  approver         User?             @relation("Approver", fields: [approverId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  organizerProfile OrganizerProfile? @relation("OrganizerApprovals", fields: [organizerProfileId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  event            Event?            @relation("EventApprovals", fields: [eventId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  liquorRequest    LiquorRequest?
}

model Report {
  id        String   @id @default(uuid())
  eventId   String
  authorId  String?
  content   String
  createdAt DateTime @default(now())

  event  Event @relation(fields: [eventId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
}

model Theme {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  imageUrl    String?
  image       Bytes?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events Event[]
}

model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Calendar {
  id          String   @id @default(uuid())
  date        DateTime
  startTime   String
  endTime     String
  venueIds    Json
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  createdBy User?     @relation("UserCreatedCalendars", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: Cascade)
  bookings  Booking[] @relation("CalendarBookings")

  @@unique([date, startTime, endTime])
}
